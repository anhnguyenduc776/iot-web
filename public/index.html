<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Gi√°m S√°t IoT</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <img src="logotruong.jpg" alt="Logo Tr∆∞·ªùng" onerror="this.src='https://via.placeholder.com/150x150?text=Logo'">
            <h2>H·ªá Th·ªëng Gi√°m S√°t IoT</h2>
        </div>
        <nav>
            <ul>
                <li><a href="#" class="nav-link active" data-page="home"><i class="fas fa-home"></i> Trang ch·ªß</a></li>
                <li><a href="#" class="nav-link" data-page="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                <li><a href="#" class="nav-link" data-page="intro"><i class="fas fa-info-circle"></i> Gi·ªõi thi·ªáu</a></li>
                <li><a href="#" class="nav-link" data-page="settings"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</a></li>
                <li><a href="#" class="nav-link" data-page="info"><i class="fas fa-info"></i> Th√¥ng tin</a></li>
            </ul>
        </nav>
    </div>

    <div class="main-content">
        <header>
            <div class="header-content">
                <h1>TR∆Ø·ªúNG ƒê·∫†I H·ªåC GIAO TH√îNG V·∫¨N T·∫¢I</h1>
                <h2>PH√ÇN HI·ªÜU T·∫†I TP. H·ªí CH√ç MINH</h2>
            </div>
            <div class="user-info">
                <i class="fas fa-user"></i>
            </div>
        </header>

        <!-- Home Page Content -->
        <div class="page-content" id="home-page">
            <div class="home-content">
                <div class="project-intro">
                    <h2>Gi·ªõi Thi·ªáu ƒê·ªÅ T√†i</h2>
                    <div class="intro-content">
                        <h3>H·ªá Th·ªëng Gi√°m S√°t Nhi·ªát ƒê·ªô V√† N·ªìng ƒê·ªô Kh√≠ Gas Th√¥ng Minh</h3>
                        <p>
                            ƒê·ªÅ t√†i c·ªßa ch√∫ng t√¥i t·∫≠p trung v√†o vi·ªác x√¢y d·ª±ng m·ªôt h·ªá th·ªëng IoT th√¥ng minh, gi√∫p gi√°m s√°t v√† c·∫£nh b√°o nhi·ªát ƒë·ªô c√πng n·ªìng ƒë·ªô kh√≠ gas trong m√¥i tr∆∞·ªùng. V·ªõi vi·ªác s·ª≠ d·ª•ng ESP32 l√†m trung t√¢m x·ª≠ l√Ω, k·∫øt h·ª£p c·∫£m bi·∫øn DHT22 ƒëo nhi·ªát ƒë·ªô v√† MQ-2 ph√°t hi·ªán kh√≠ gas, h·ªá th·ªëng c√≥ th·ªÉ theo d√µi v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu theo th·ªùi gian th·ª±c.
                        </p>

                        <!-- Th√™m ph·∫ßn hi·ªÉn th·ªã ·∫£nh m√¥ h√¨nh -->
                        <div class="model-images">
                            <div class="model-image-container">
                                <button class="nav-arrow left" onclick="prevImage()">‚ùÆ</button>
                                <div class="image-wrapper">
                                    <img src="images/mohinh1.jpg" alt="M√¥ h√¨nh h·ªá th·ªëng" id="modelImage" onerror="this.src='https://via.placeholder.com/800x600?text=M√¥+h√¨nh+h·ªá+th·ªëng'">
                                </div>
                                <button class="nav-arrow right" onclick="nextImage()">‚ùØ</button>
                            </div>
                        </div>
                        <div class="system-diagram">
                            
                            <img src="system-diagram.jpg" alt="S∆° ƒë·ªì h·ªá th·ªëng" onerror="this.src='https://via.placeholder.com/800x400?text=S∆°+ƒë·ªì+h·ªá+th·ªëng'" style="max-width: 100%; margin: 20px 0;">

                        </div>
                    </div>
                </div>

                <div class="features">
                    <h2>T√≠nh NƒÉng Chi Ti·∫øt</h2>
                    <div class="features-grid">
                        <div class="feature-box energy-saving">
                            <i class="fas fa-moon"></i>
                            <h3>Ch·ª©c NƒÉng Ng·ªß Ti·∫øt Ki·ªám NƒÉng L∆∞·ª£ng</h3>
                            <p>T·ª± ƒë·ªông gi·∫£m ti√™u th·ª• ƒëi·ªán khi kh√¥ng c·∫ßn thi·∫øt</p>
                        </div>
                        <div class="feature-box gas-detection">
                            <i class="fas fa-smog"></i>
                            <h3>Ph√°t Hi·ªán R√≤ R·ªâ Kh√≠ Gas</h3>
                            <p>Gi√°m s√°t li√™n t·ª•c v√† ph√°t hi·ªán s·ªõm r√≤ r·ªâ</p>
                        </div>
                        <div class="feature-box alert">
                            <i class="fas fa-bell"></i>
                            <h3>C·∫£nh B√°o T·ª©c Th√¨</h3>
                            <p>Th√¥ng b√°o ngay l·∫≠p t·ª©c khi v∆∞·ª£t ng∆∞·ª°ng an to√†n</p>
                        </div>
                        <div class="feature-box monitoring">
                            <i class="fas fa-laptop"></i>
                            <h3>Theo D√µi T·ª´ M·ªçi Thi·∫øt B·ªã</h3>
                            <p>Qu·∫£n l√Ω h·ªá th·ªëng t·ª´ b·∫•t k·ª≥ ƒë√¢u qua web</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="page-content" id="dashboard-page" style="display: none;">
            <div class="dashboard">
                <h2 class="dashboard-title">B·∫£ng ƒêi·ªÅu Khi·ªÉn Gi√°m S√°t</h2>
                
                <!-- Sensor readings -->
                <div class="sensor-container">
                    <div class="sensor-card">
                        <div class="sensor-icon">üå°Ô∏è</div>
                        <div class="sensor-label">Nhi·ªát ƒê·ªô</div>
                        <div class="sensor-value temperature-value" id="temperature">--</div>
                        <div class="sensor-unit">¬∞C</div>
                        <div class="alert-status" id="temperatureAlert"></div>
                    </div>

                    <div class="sensor-card">
                        <div class="sensor-icon">üíß</div>
                        <div class="sensor-label">ƒê·ªô ·∫®m</div>
                        <div class="sensor-value humidity-value" id="humidity">--</div>
                        <div class="sensor-unit">%</div>
                        <div class="alert-status" id="humidityAlert"></div>
                    </div>

                    <div class="sensor-card">
                        <div class="sensor-icon">üí®</div>
                        <div class="sensor-label">Kh√≠ Gas</div>
                        <div class="sensor-value gas-value" id="gas">--</div>
                        <div class="sensor-unit">ppm</div>
                        <div class="alert-status" id="gasAlert"></div>
                    </div>
                </div>

                <!-- Control Panel -->
                <div class="control-panel">
                    <h2>ƒêi·ªÅu Khi·ªÉn Thi·∫øt B·ªã</h2>
                    <div class="control-container">
                        <!-- Fan Control -->
                        <div class="control-box">
                            <div class="control-icon">
                                <i class="fas fa-fan"></i>
                            </div>
                            <h3>Qu·∫°t</h3>
                            <div class="control-status" id="fan-status">ƒêang t·∫Øt</div>
                            <button class="control-button" id="fan-toggle" onclick="toggleDevice('fan')">
                                <i class="fas fa-power-off"></i> B·∫≠t/T·∫Øt
                            </button>
                        </div>

                        <!-- Pump Control -->
                        <div class="control-box">
                            <div class="control-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <h3>B∆°m</h3>
                            <div class="control-status" id="pump-status">ƒêang t·∫Øt</div>
                            <button class="control-button" id="pump-toggle" onclick="toggleDevice('pump')">
                                <i class="fas fa-power-off"></i> B·∫≠t/T·∫Øt
                            </button>
                        </div>

                        <!-- Sleep Mode Control -->
                        <div class="control-section">
                            <h3>Ch·∫ø ƒê·ªô Ng·ªß</h3>
                            <div class="sleep-control">
                                <div class="time-input">
                                    <label>Th·ªùi gian ng·ªß (ph√∫t):</label>
                                    <div class="time-input-group">
                                        <input type="number" id="sleepTime" min="1" max="120" value="30" style="width: 100px;">
                                        <button id="sendTime" class="control-button" style="padding: 8px 12px; font-size: 14px;">
                                            <i class="fas fa-paper-plane"></i> G·ª≠i
                                        </button>
                                    </div>
                                </div>
                                <div class="sleep-status">
                                    <span id="sleepStatus">Ch·∫ø ƒë·ªô ng·ªß: T·∫Øt</span>
                                </div>
                                <div class="sleep-buttons">
                                    <button id="sleepOn" class="control-button">
                                        <i class="fas fa-power-off"></i> B·∫≠t Ch·∫ø ƒê·ªô Ng·ªß
                                    </button>
                                    <button id="sleepOff" class="control-button">
                                        <i class="fas fa-power-off"></i> T·∫Øt Ch·∫ø ƒê·ªô Ng·ªß
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Th√™m n√∫t xem l·ªãch s·ª≠ email -->
                        <div class="control-section">
                            <h3>L·ªãch s·ª≠ c·∫£nh b√°o</h3>
                            <div class="alert-history">
                                <button id="viewAlertHistory" class="control-button">Xem l·ªãch s·ª≠ c·∫£nh b√°o</button>
                                <div id="alertHistory" class="alert-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Introduction Page Content -->
        <div class="page-content" id="intro-page" style="display: none;">
            <div class="team-section">
                <h2>Th√†nh Vi√™n Nh√≥m</h2>
                <div class="team-grid">
                    <!-- Th√†nh vi√™n 1 -->
                    <div class="team-member">
                        <div class="member-image">
                            <img src="images/member1.jpg" alt="Tr·∫ßn Trung Nh√¢n" onerror="this.src='https://via.placeholder.com/300x300?text=Tr·∫ßn+Trung+Nh√¢n'">
                        </div>
                        <div class="member-info">
                            <h3>Tr·∫ßn Trung Nh√¢n</h3>
                            <p class="role">Th√†nh vi√™n</p>
                            <p class="student-id">MSSV: 6351030049</p>
                            <div class="member-social">
                                <a href="#" class="social-icon">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="social-icon">
                                    <i class="fab fa-github"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Th√†nh vi√™n 2 -->
                    <div class="team-member">
                        <div class="member-image">
                            <img src="images/member2.jpg" alt="Nguy·ªÖn Tr·ªãnh Thanh ƒê·∫°t" onerror="this.src='https://via.placeholder.com/300x300?text=Nguy·ªÖn+Tr·ªãnh+Thanh+ƒê·∫°t'">
                        </div>
                        <div class="member-info">
                            <h3>Nguy·ªÖn Tr·ªãnh Thanh ƒê·∫°t</h3>
                            <p class="role">Th√†nh vi√™n</p>
                            <p class="student-id">MSSV: 63510300</p>
                            <div class="member-social">
                                <a href="#" class="social-icon">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="social-icon">
                                    <i class="fab fa-github"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Th√†nh vi√™n 3 -->
                    <div class="team-member">
                        <div class="member-image">
                            <img src="images/member3.jpg" alt="Tr·∫ßn Nguy√™n H·∫°o" onerror="this.src='https://via.placeholder.com/300x300?text=Tr·∫ßn+Nguy√™n+H·∫°o'">
                        </div>
                        <div class="member-info">
                            <h3>Tr·∫ßn Nguy√™n H·∫°o</h3>
                            <p class="role">Th√†nh vi√™n</p>
                            <p class="student-id">MSSV: 6351030049</p>
                            <div class="member-social">
                                <a href="#" class="social-icon">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="#" class="social-icon">
                                    <i class="fab fa-github"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Th√†nh vi√™n 4 -->
                    <div class="team-member">
                        <div class="member-image">
                            <img src="images/member4.jpg" alt="Nguy·ªÖn ƒê·ª©c √Ånh" onerror="this.src='https://via.placeholder.com/300x300?text=Nguy·ªÖn+ƒê·ª©c+√Ånh'">
                        </div>
                        <div class="member-info">
                            <h3>Nguy·ªÖn ƒê·ª©c √Ånh</h3>
                            <p class="role">Tr∆∞·ªüng nh√≥m</p>
                            <p class="student-id">MSSV: 6351030005</p>
                            <div class="member-social">
                                <a href="https://www.facebook.com/profile.php?id=100052773906365" target="_blank" rel="noopener noreferrer" class="social-icon">
                                    <i class="fab fa-facebook-f"></i>
                                </a>
                                <a href="https://github.com/anhnguyenduc776" target="_blank" rel="noopener noreferrer" class="social-icon">
                                    <i class="fab fa-github"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>¬© 2024 H·ªá Th·ªëng Gi√°m S√°t IoT.</p>
        </footer>
    </div>

    <style>
    /* Control Panel Styles */
    .control-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-top: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .control-panel h2 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 20px;
    }

    .control-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        padding: 10px;
    }

    .control-box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .control-box:hover {
        transform: translateY(-5px);
    }

    .control-icon {
        font-size: 2em;
        color: #3498db;
        margin-bottom: 10px;
    }

    .control-box h3 {
        color: #2c3e50;
        margin: 10px 0;
    }

    .control-status {
        color: #7f8c8d;
        margin: 10px 0;
        font-size: 0.9em;
    }

    .control-button {
        background: #3498db;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s ease;
        width: 100%;
        margin-top: 10px;
    }

    .control-button:hover {
        background: #2980b9;
    }

    .control-button.active {
        background: #27ae60;
    }

    .control-status.on {
        color: #27ae60;
    }

    .control-status.off {
        color: #e74c3c;
    }

    .sleep-control {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .time-input {
        margin-bottom: 15px;
    }

    .time-input label {
        display: block;
        margin-bottom: 5px;
        color: #333;
    }

    .time-input input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }

    .sleep-status {
        margin: 15px 0;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
    }

    .sleep-buttons {
        display: flex;
        gap: 10px;
    }

    .sleep-buttons button {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
    }

    #sleepOn {
        background: #4CAF50;
        color: white;
    }

    #sleepOn:hover {
        background: #45a049;
    }

    #sleepOff {
        background: #f44336;
        color: white;
    }

    #sleepOff:hover {
        background: #da190b;
    }

    .alert-history {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .alert-list {
        margin-top: 15px;
        max-height: 200px;
        overflow-y: auto;
    }

    .alert-item {
        background-color: white;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .alert-item.warning {
        border-left: 4px solid #ffc107;
    }

    .alert-item.danger {
        border-left: 4px solid #dc3545;
    }

    .alert-time {
        font-size: 0.8em;
        color: #6c757d;
    }

    .alert-message {
        margin-top: 5px;
        font-weight: bold;
    }

    .time-input-group {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: flex-start;
    }

    .time-input-group input {
        width: 100px;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }

    .time-input-group button {
        padding: 8px 12px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
        font-size: 14px;
        white-space: nowrap;
    }

    .time-input-group button:hover {
        background: #1976D2;
    }
    </style>

    <script>
        // Navigation
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all links
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                // Add active class to clicked link
                this.classList.add('active');
                
                // Hide all pages
                document.querySelectorAll('.page-content').forEach(page => {
                    page.style.display = 'none';
                });
                
                // Show selected page
                const pageId = this.getAttribute('data-page') + '-page';
                const selectedPage = document.getElementById(pageId);
                if (selectedPage) {
                    selectedPage.style.display = 'block';
                    console.log('Showing page:', pageId);
                } else {
                    console.error('Page not found:', pageId);
                }
            });
        });

        // Show home page by default
        document.getElementById('home-page').style.display = 'block';
        });

        // MQTT Configuration
        const mqttConfig = {
            host: 'test.mosquitto.org',
        port: 8080,
            protocol: 'ws',
        clientId: 'anhnguyenduc04/iot_web_' + Math.random().toString(16).substr(2, 8)
        };

    // Topics to subscribe
        const topics = {
        main: 'anhnguyenduc04/iot'
    };

    // Connect to MQTT broker
    console.log('ƒêang k·∫øt n·ªëi ƒë·∫øn MQTT broker...');
    const client = mqtt.connect(`ws://${mqttConfig.host}:${mqttConfig.port}/mqtt`);

    // Handle connection
    client.on('connect', () => {
        console.log('ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng ƒë·∫øn MQTT broker');
        updateAllConnectionStatus(true);
        
        // Subscribe to main topic
        client.subscribe(topics.main, (err) => {
            if (err) {
                console.error('L·ªói khi subscribe topic:', err);
                updateAllConnectionStatus(false);
            } else {
                console.log('ƒê√£ subscribe th√†nh c√¥ng ƒë·∫øn topic:', topics.main);
            }
        });
    });

    // Handle incoming messages
    client.on('message', (topic, message) => {
        try {
            console.log('Nh·∫≠n ƒë∆∞·ª£c d·ªØ li·ªáu:', topic, message.toString());
            if (topic === topics.main) {
                const data = JSON.parse(message.toString());
                updateSensorData(data);
            }
        } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu:', error);
        }
    });

    // Kh·ªüi t·∫°o EmailJS v·ªõi Gmail
    (function() {
        // Public Key c·ªßa b·∫°n t·ª´ EmailJS
        emailjs.init("public_key");
    })();

    // C·∫•u h√¨nh c·∫£nh b√°o
    const alertConfig = {
        thresholds: {
            temperature: 35,  // Nhi·ªát ƒë·ªô cao > 35¬∞C
            humidity: 30     // ƒê·ªô ·∫©m th·∫•p < 30%
        },
        interval: 60000,     // 1 ph√∫t
        email: {
            to: "ducanh20102004@gmail.com",
            serviceId: "service_gmail",  // Service ID t·ª´ EmailJS
            templateId: "template_alert", // Template ID t·ª´ EmailJS
            from: "H·ªá th·ªëng IoT"
        }
    };

    // H√†m g·ª≠i c·∫£nh b√°o qua Gmail
    function sendAlert(type, value) {
        const templateParams = {
            to_name: "Ng∆∞·ªùi qu·∫£n l√Ω",
            to_email: alertConfig.email.to,
            from_name: alertConfig.email.from,
            subject: `[C·∫¢NH B√ÅO] ${type === 'temperature' ? 'Nhi·ªát ƒë·ªô cao' : 'ƒê·ªô ·∫©m th·∫•p'} - H·ªá th·ªëng IoT`,
            message: `
üö® C·∫¢NH B√ÅO QUAN TR·ªåNG!

${type === 'temperature' ? 'üå°Ô∏è Nhi·ªát ƒë·ªô ƒë√£ v∆∞·ª£t ng∆∞·ª°ng cho ph√©p!' : 'üíß ƒê·ªô ·∫©m ƒë√£ xu·ªëng qu√° th·∫•p!'}

Chi ti·∫øt:
- Lo·∫°i c·∫£nh b√°o: ${type === 'temperature' ? 'Nhi·ªát ƒë·ªô cao' : 'ƒê·ªô ·∫©m th·∫•p'}
- Gi√° tr·ªã hi·ªán t·∫°i: ${value}${type === 'temperature' ? '¬∞C' : '%'}
- Ng∆∞·ª°ng c·∫£nh b√°o: ${type === 'temperature' ? '>' + alertConfig.thresholds.temperature + '¬∞C' : '<' + alertConfig.thresholds.humidity + '%'}
- Th·ªùi gian: ${new Date().toLocaleString('vi-VN')}

‚ö†Ô∏è Vui l√≤ng ki·ªÉm tra v√† c√≥ bi·ªán ph√°p x·ª≠ l√Ω k·ªãp th·ªùi!

--
Tr√¢n tr·ªçng,
H·ªá th·ªëng Gi√°m s√°t IoT
        `
        };

        emailjs.send(alertConfig.email.serviceId, alertConfig.email.templateId, templateParams)
            .then(function(response) {
                console.log('‚úÖ ƒê√£ g·ª≠i email c·∫£nh b√°o th√†nh c√¥ng!');
                showNotification('ƒê√£ g·ª≠i c·∫£nh b√°o', `ƒê√£ g·ª≠i email c·∫£nh b√°o ƒë·∫øn ${alertConfig.email.to}`, 'success');
            })
            .catch(function(error) {
                console.error('‚ùå L·ªói khi g·ª≠i email:', error);
                showNotification('L·ªói g·ª≠i c·∫£nh b√°o', 'Kh√¥ng th·ªÉ g·ª≠i email c·∫£nh b√°o. Vui l√≤ng ki·ªÉm tra l·∫°i.', 'error');
            });
    }

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o
    function showNotification(title, message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <h4>${title}</h4>
            <p>${message}</p>
        `;
        document.body.appendChild(notification);

        // T·ª± ƒë·ªông ·∫©n sau 5 gi√¢y
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Th√™m style cho notification
    const style = document.createElement('style');
    style.textContent = `
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        background: white;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        animation: slideIn 0.5s ease;
    }

    .notification.success {
        border-left: 4px solid #4CAF50;
    }

    .notification.error {
        border-left: 4px solid #f44336;
    }

    .notification h4 {
        margin: 0 0 5px 0;
        color: #333;
    }

    .notification p {
        margin: 0;
        color: #666;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    `;
    document.head.appendChild(style);

    // C·∫≠p nh·∫≠t h√†m updateSensorData ƒë·ªÉ th√™m ki·ªÉm tra c·∫£nh b√°o
    function updateSensorData(data) {
        try {
            // Update temperature
            const tempElement = document.getElementById('temperature');
            if (tempElement && data.temperature !== undefined) {
                tempElement.textContent = `${data.temperature.toFixed(1)}¬∞C`;
                updateConnectionStatus('temp-status', true);
            }
            
            // Update humidity
            const humidityElement = document.getElementById('humidity');
            if (humidityElement && data.humidity !== undefined) {
                humidityElement.textContent = `${data.humidity.toFixed(1)}%`;
                updateConnectionStatus('humidity-status', true);
            }

            // Ki·ªÉm tra v√† g·ª≠i c·∫£nh b√°o
            checkAndSendAlert(data);
        } catch (error) {
            console.error('L·ªói khi c·∫≠p nh·∫≠t d·ªØ li·ªáu c·∫£m bi·∫øn:', error);
        }
    }

    // Update all connection status
    function updateAllConnectionStatus(isConnected) {
        updateConnectionStatus('temp-status', isConnected);
        updateConnectionStatus('humidity-status', isConnected);
    }

        // Update connection status
        function updateConnectionStatus(elementId, isConnected) {
            const status = document.getElementById(elementId);
        if (status) {
            const dot = status.querySelector('.status-dot');
            const text = status.querySelector('.status-text');
            
            if (isConnected) {
                dot.style.backgroundColor = '#4CAF50';
                text.textContent = 'ƒê√£ k·∫øt n·ªëi';
            } else {
                dot.style.backgroundColor = '#f44336';                text.textContent = 'ƒêang k·∫øt n·ªëi...';
            }
        }
    }

    // Handle connection errors
    client.on('error', (err) => {
        console.error('L·ªói MQTT:', err);
        updateAllConnectionStatus(false);
    });

    // Handle disconnection
    client.on('close', () => {
        console.log('M·∫•t k·∫øt n·ªëi v·ªõi MQTT broker');
        updateAllConnectionStatus(false);
    });

    // Handle offline status
    client.on('offline', () => {
        console.log('Client ƒëang offline');
        updateAllConnectionStatus(false);
    });

    // Initial status update
    updateAllConnectionStatus(false);

    // Device states
    const deviceStates = {
        fan: false,
        pump: false,
        sleep: false
    };

    // Topics for publishing
    const publishTopics = {
        fan: 'anhnguyenduc04/iot/fan',
        pump: 'anhnguyenduc04/iot/pump',
        sleep: 'anhnguyenduc04/iot/sleep'
    };

    // Toggle device function
    function toggleDevice(device) {
        if (!client.connected) {
            alert('Ch∆∞a k·∫øt n·ªëi ƒë·∫øn MQTT broker!');
            return;
        }

        deviceStates[device] = !deviceStates[device];
        const state = deviceStates[device];
        
        // Publish to MQTT
        client.publish(publishTopics[device], state ? '1' : '0', { qos: 1 }, (error) => {
            if (error) {
                console.error(`L·ªói khi g·ª≠i l·ªánh ${device}:`, error);
                return;
            }
            
            // Update UI
            const statusElement = document.getElementById(`${device}-status`);
            const buttonElement = document.getElementById(`${device}-toggle`);
            
            if (statusElement) {
                statusElement.textContent = state ? 'ƒêang b·∫≠t' : 'ƒêang t·∫Øt';
                statusElement.className = `control-status ${state ? 'on' : 'off'}`;
            }
            
            if (buttonElement) {
                buttonElement.className = `control-button ${state ? 'active' : ''}`;
            }
        });
    }

    // Subscribe to device status topics
    client.on('connect', () => {
        // ... existing connection code ...
        
        // Subscribe to device status topics
        Object.values(publishTopics).forEach(topic => {
            client.subscribe(topic, (err) => {
                if (err) {
                    console.error('L·ªói khi subscribe topic thi·∫øt b·ªã:', err);
                } else {
                    console.log('ƒê√£ subscribe topic thi·∫øt b·ªã:', topic);
                }
            });
            });
        });

    // Handle incoming device status messages
        client.on('message', (topic, message) => {
            try {
            const value = message.toString();
            
            // Update device states based on topic
            Object.entries(publishTopics).forEach(([device, deviceTopic]) => {
                if (topic === deviceTopic) {
                    const state = value === '1';
                    deviceStates[device] = state;
                    
                    const statusElement = document.getElementById(`${device}-status`);
                    const buttonElement = document.getElementById(`${device}-toggle`);
                    
                    if (statusElement) {
                        statusElement.textContent = state ? 'ƒêang b·∫≠t' : 'ƒêang t·∫Øt';
                        statusElement.className = `control-status ${state ? 'on' : 'off'}`;
                    }
                    
                    if (buttonElement) {
                        buttonElement.className = `control-button ${state ? 'active' : ''}`;
                    }
                }
            });
            } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω tr·∫°ng th√°i thi·∫øt b·ªã:', error);
        }
    });

    // Th√™m x·ª≠ l√Ω cho n√∫t g·ª≠i th·ªùi gian
    document.getElementById('sendTime').addEventListener('click', function() {
        const sleepTime = document.getElementById('sleepTime').value;
        if (sleepTime < 1 || sleepTime > 120) {
            alert('Vui l√≤ng nh·∫≠p th·ªùi gian t·ª´ 1 ƒë·∫øn 120 ph√∫t');
            return;
        }
        
        // G·ª≠i th·ªùi gian qua MQTT
        if (client && client.connected) {
            const timeCommand = {
                type: 'sleep',
                action: 'set_time',
                duration: parseInt(sleepTime)
            };
            
            client.publish('anhnguyenduc04/iot/sleep/time', JSON.stringify(timeCommand), { qos: 1 }, (error) => {
                if (error) {
                    console.error('L·ªói khi g·ª≠i th·ªùi gian:', error);
                    showNotification('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i th·ªùi gian', 'error');
                } else {
                    console.log('ƒê√£ g·ª≠i th·ªùi gian:', sleepTime);
                    showNotification('Th√†nh c√¥ng', `ƒê√£ g·ª≠i th·ªùi gian ng·ªß: ${sleepTime} ph√∫t`, 'success');
                }
            });
        } else {
            showNotification('L·ªói', 'Ch∆∞a k·∫øt n·ªëi ƒë·∫øn MQTT', 'error');
        }
    });

    // C·∫≠p nh·∫≠t x·ª≠ l√Ω cho n√∫t b·∫≠t ch·∫ø ƒë·ªô ng·ªß
    document.getElementById('sleepOn').addEventListener('click', function() {
        if (client && client.connected) {
            client.publish('anhnguyenduc04/iot/sleep', 'ON', { qos: 1 }, (error) => {
                if (error) {
                    console.error('L·ªói khi b·∫≠t ch·∫ø ƒë·ªô ng·ªß:', error);
                    showNotification('L·ªói', 'Kh√¥ng th·ªÉ b·∫≠t ch·∫ø ƒë·ªô ng·ªß', 'error');
                } else {
                    console.log('ƒê√£ g·ª≠i l·ªánh b·∫≠t ch·∫ø ƒë·ªô ng·ªß');
                    document.getElementById('sleepStatus').textContent = 'Ch·∫ø ƒë·ªô ng·ªß: ƒêang b·∫≠t';
                    document.getElementById('sleepStatus').style.color = '#4CAF50';
                    showNotification('Th√†nh c√¥ng', 'ƒê√£ b·∫≠t ch·∫ø ƒë·ªô ng·ªß', 'success');
                }
            });
        } else {
            showNotification('L·ªói', 'Ch∆∞a k·∫øt n·ªëi ƒë·∫øn MQTT', 'error');
        }
    });

    // C·∫≠p nh·∫≠t x·ª≠ l√Ω cho n√∫t t·∫Øt ch·∫ø ƒë·ªô ng·ªß
    document.getElementById('sleepOff').addEventListener('click', function() {
        if (client && client.connected) {
            client.publish('anhnguyenduc04/iot/sleep', 'OFF', { qos: 1 }, (error) => {
                if (error) {
                    console.error('L·ªói khi t·∫Øt ch·∫ø ƒë·ªô ng·ªß:', error);
                    showNotification('L·ªói', 'Kh√¥ng th·ªÉ t·∫Øt ch·∫ø ƒë·ªô ng·ªß', 'error');
                } else {
                    console.log('ƒê√£ g·ª≠i l·ªánh t·∫Øt ch·∫ø ƒë·ªô ng·ªß');
                    document.getElementById('sleepStatus').textContent = 'Ch·∫ø ƒë·ªô ng·ªß: ƒêang t·∫Øt';
                    document.getElementById('sleepStatus').style.color = '#f44336';
                    showNotification('Th√†nh c√¥ng', 'ƒê√£ t·∫Øt ch·∫ø ƒë·ªô ng·ªß', 'success');
                }
            });
        } else {
            showNotification('L·ªói', 'Ch∆∞a k·∫øt n·ªëi ƒë·∫øn MQTT', 'error');
        }
    });

    // Th√™m x·ª≠ l√Ω tin nh·∫Øn MQTT cho ch·∫ø ƒë·ªô ng·ªß
    client.on('message', (topic, message) => {
        try {
            if (topic === 'anhnguyenduc04/iot/sleep/status') {
                const status = message.toString();
                const statusElement = document.getElementById('sleepStatus');
                
                if (status === 'ON') {
                    statusElement.textContent = 'Ch·∫ø ƒë·ªô ng·ªß: ƒêang b·∫≠t';
                    statusElement.style.color = '#4CAF50';
                } else if (status === 'OFF') {
                    statusElement.textContent = 'Ch·∫ø ƒë·ªô ng·ªß: ƒêang t·∫Øt';
                    statusElement.style.color = '#f44336';
                }
            }
        } catch (error) {
            console.error('L·ªói khi x·ª≠ l√Ω tr·∫°ng th√°i ch·∫ø ƒë·ªô ng·ªß:', error);
        }
    });

    // Th√™m v√†o ph·∫ßn JavaScript
    document.getElementById('viewAlertHistory').addEventListener('click', function() {
        fetch('/api/logs')
            .then(response => response.text())
            .then(logs => {
                const alertHistory = document.getElementById('alertHistory');
                alertHistory.innerHTML = '';
                
                // L·ªçc c√°c log li√™n quan ƒë·∫øn c·∫£nh b√°o
                const alertLogs = logs.split('\n').filter(log => 
                    log.includes('C·∫¢NH B√ÅO') || 
                    log.includes('Nhi·ªát ƒë·ªô') || 
                    log.includes('ƒê·ªô ·∫©m')
                );
                
                alertLogs.reverse().forEach(log => {
                    const alertItem = document.createElement('div');
                    alertItem.className = 'alert-item';
                    
                    if (log.includes('v∆∞·ª£t ng∆∞·ª°ng')) {
                        alertItem.classList.add('danger');
                    } else {
                        alertItem.classList.add('warning');
                    }
                    
                    const time = document.createElement('div');
                    time.className = 'alert-time';
                    time.textContent = log.split(' - ')[0];
                    
                    const message = document.createElement('div');
                    message.className = 'alert-message';
                    message.textContent = log.split(' - ')[1];
                    
                    alertItem.appendChild(time);
                    alertItem.appendChild(message);
                    alertHistory.appendChild(alertItem);
                });
            })
            .catch(error => {
                console.error('L·ªói khi l·∫•y l·ªãch s·ª≠:', error);
                alert('Kh√¥ng th·ªÉ l·∫•y l·ªãch s·ª≠ c·∫£nh b√°o');
            });
    });

    // Image navigation
    const images = [
        'images/mohinh1.jpg',
        'images/mohinh2.jpg'
    ];
    let currentImageIndex = 0;
    const modelImage = document.getElementById('modelImage');

    function updateImage() {
        modelImage.src = images[currentImageIndex];
    }

    function nextImage() {
        currentImageIndex = (currentImageIndex + 1) % images.length;
        updateImage();
    }

    function prevImage() {
        currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
        updateImage();
    }

    // Add keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') {
            prevImage();
        } else if (e.key === 'ArrowRight') {
            nextImage();
        }
        });
    </script>
</body>
</html> 
